---
layout: default_dyn
title: Search
permalink: /pages/fisbroker/search/
level: 2
---

<div class="container">
    <div class="row">
		<div class="col col-md-2 col-lg-3"></div>
		<div class="col col-sm-12 col-md-8 col-lg-6">
            <input type="text" id="searchslot" />
        </div>
        <div class="col col-md-2 col-lg-3"></div>
    </div>
    <div class="row">
		<div class="col col-md-2 col-lg-3"></div>
		<div class="col col-sm-12 col-md-8 col-lg-6">
            <a id="taglink">Toggle TagCloud</a><br />
            <div id="tagcloud">

            </div>
        </div>
        <div class="col col-md-2 col-lg-3"></div>
    </div>
    <div class="row">
		<div class="col col-md-2 col-lg-3"></div>
		<div class="col col-sm-12 col-md-8 col-lg-6">
            <a id="catlink">Toggle Categories</a><br />
            <div id="categories">

            </div>
        </div>
        <div class="col col-md-2 col-lg-3"></div>
    </div>
    <div class="row">
		<div class="col col-md-2 col-lg-3"></div>
		<div class="col col-sm-12 col-md-8 col-lg-6">
            <div id="types">
                <div>
                    <label>All</label>
                    <input type="radio" name="type" value="all" class="typetoggle" checked="checked" />
                </div>
                <div>
                    <label>WFS</label>
                    <input type="radio" name="type" value="wfs" class="typetoggle" />
                </div>
                <div>
                    <label>WMS</label>
                    <input type="radio" name="type" value="wms" class="typetoggle" />
                </div>
                <div>
                    <label>FEED</label>
                    <input type="radio" name="type" value="feed" class="typetoggle" />
                </div>
            </div>
        </div>
        <div class="col col-md-2 col-lg-3"></div>
    </div>
    <div class="row">
        <table id="searchtable">
            <thead>
                <tr>
                    <th>Preview</th>
                    <th>Title</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody id="table">
            </tbody>
            <thead>
                <tr>
                    <th>Preview</th>
                    <th>Title</th>
                    <th>Type</th>
                </tr>
            </thead>
        </table>
    </div>
</div>
<script src="{{ site.url }}/lib/d3.min.js"></script>
<script src="{{ site.url }}/lib/topojson.v1.min.js"></script>
<script src="{{ site.url }}/lib/lunr.min.js"></script>
<script>

    var url = "{{site.url}}";

    var index = lunr(function () {
        this.field('type');
        this.field('name');
        this.field('title');
        this.field('description');
        this.field('keywords');
        this.field('thumb');
        this.field('category');
        this.ref('id');
    });

    var keywords = {}, categories = {};

    d3.json('https://raw.githubusercontent.com/sebastian-meier/BerlinRefinedAssets/master/tools/fisbroker/light.json', function(data){

        for(var i = 0; i<data.length; i++){
            var tkeywordstr = "";
            if($.isArray(data[i][4])){
                tkeywordstr = data[i][4].join();
            }
            index.add({
                type: data[i][0],
                name: data[i][1],
                title: data[i][2],
                description: data[i][3],
                keywords: tkeywordstr,
                thumb: data[i][5],
                category: data[i][6],
                id: i
            });

            if($.isArray(data[i][4])){
                for(var j = 0; j<data[i][4].length; j++){
                    if(data[i][4][j] in keywords){
                        keywords[data[i][4][j]]++;
                    }else{
                        keywords[data[i][4][j]] = 1;
                    }
                }
            }

            if(data[i][6] in categories){
                categories[data[i][6]]++;
            }else{
                categories[data[i][6]]=1;
            }
        }

        var keys = [];
        var min = Number.MAX_VALUE,
            max = -Number.MAX_VALUE;

        var i = 0;
        var keywordsmap = {};
        for(var key in keywords){
            keys.push({
                id:i,
                t:key,
                c:keywords[key]
            });
            if(keywords[key] < min){min = keywords[key];}
            if(keywords[key] > max){max = keywords[key];}
            keywordsmap[key] = i;
            i++;
        }

        var size = d3.scale.linear().domain([min,max]).range([10,20]);

        var cats = [];
        var catmap = {};
        var i = 0;
        for(var key in categories){
            cats.push({
                id:i,
                t:key,
                c:categories[key]
            });
            catmap[key] = i;
            i++;
        }

        d3.selectAll('.typetoggle').on('change',function(){
            var val = d3.select('input[name="type"]:checked').node().value;
            filters.type = val;
            updateList();
        });

        d3.select('#taglink').on('click',function(){
            if(d3.select('#tagcloud').style("display")==="block"){
                d3.select('#tagcloud').style("display","none");
            }else{
                d3.select('#tagcloud').style("display","block");
            }
        });

        d3.select('#catlink').on('click',function(){
            if(d3.select('#categories').style("display")==="block"){
                d3.select('#categories').style("display","none");
            }else{
                d3.select('#categories').style("display","block");
            }
        });

        d3.select('#categories').selectAll('a').data(cats).enter().append('a')
            .attr('class', function(d){ return 'category cat-'+d.id; })
            .on('click',function(){
                d3.selectAll('.category').classed('active', false);
                var d = (d3.select(this)).datum();
                if(d.id === filters.category){
                    filters.category = false;
                }else{
                    filters.category = d.id;
                    d3.select('.cat-'+d.id).classed('active',true);
                }
                updateList();
            })
            .text(function(d){ return d.t+" ("+d.c+")"; });

        d3.select('#tagcloud').selectAll('a').data(keys).enter().append('a')
            .text(function(d){return d.t;})
            .attr('class', function(d){ return 'tag'+d.id; })
            .on('click',function(){
                d3.selectAll('.tag').classed('active', false);
                var d = (d3.select(this)).datum();
                if(d.id === filters.tags){
                    filters.tags = false;
                }else{
                    filters.tag = d.id;
                    d3.select('.tag-'+d.id).classed('active',true);
                }
                updateList();
            })
            .style('display', function(d){ if(d.c >= 5){ return "inline-block"; }else{ return "none"; } })
            .style('font-size', function(d){ return size(d.c)+"px"; });

        var tr = d3.select('#table').selectAll('tr').data(data).enter().append('tr')
            .attr('class', function(d, i){
                var r = "tr ";
                r += "id-"+i;
                r += " cat-"+catmap[d[6]];
                r += " type-"+d[0];
                if($.isArray(d[4])){
                    for(var j = 0; j<d[4].length; j++){
                        r += " tag-"+keywordsmap[d[4][j]];
                    }
                }
                return r;
            });

        tr.append('td').html(function(d){ if(d[5] === false){ return ""; }else{return "<a href='{{site.url}}/pages/fisbroker/details/"+d[0]+"_"+d[1]+".html'><img src='https://raw.githubusercontent.com/sebastian-meier/BerlinRefinedAssets/master/tools/fisbroker/thumbs/small/"+d[5]+"' /></a>";} });
        tr.append('td').html(function(d){ return "<a href='{{site.url}}/pages/fisbroker/details/"+d[0]+"_"+d[1]+".html'>"+d[2]+"</a>"; });
        tr.append('td').text(function(d){ return d[0]; });

        d3.select('#searchslot').on('keyup',function(){
            var objs = index.search(this.value);
            if(this.value.length<1){
                filters.objs = false;
            }else{
                if(objs.length>=1){
                    filters.objs = objs;
                }else{
                    filters.objs = [{ref:99999999}];
                }
            }
            updateList();
        });
    });

    var filters = {
        objs:false,
        type:'all',
        tag:false,
        category:false
    };

    function updateList(){
        var f = ".tr";

        if(filters.type !== "all"){
            f += ".type-"+filters.type;
        }

        if(filters.tag){
            f += ".tag-"+filters.tag;
        }

        if(filters.category){
            f += ".cat-"+filters.category;
        }

        var selects = [];
        if(filters.objs){
            for(var i = 0; i<filters.objs.length; i++){
                selects.push(f+".id-"+filters.objs[i].ref);
            }
        }else{
            selects.push(f);
        }

        d3.selectAll('.tr').style("display","none");
        d3.selectAll(selects.join()).style("display","table-row");
    }

</script>
